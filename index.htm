<html>
<head>
<title>Tap for Beats Per Minute BPM</title>

<script src="inc/js/raphael-min.js"></script>
<script src="inc/js/g.raphael-min.js"></script>
<script src="inc/js/g.bar-min.js"></script>

<script language="JavaScript">
<!-- Original:  Derek Chilcote-Batto (dac-b@usa.net) -->
<!-- Web Site:  http://www.mixed.net -->
<!-- Rewritten by: Rich Reel all8.com -->
<!-- Re-rewritten by: Lucas garron.us -->

var count = 0;
var msecsFirst = 0;
var msecsPrevious = 0;
var lengths = [];
var lastTime = null;
var r;

function ResetCount()
{
  count = 0;
  lengths = [];
  lastTime = null;
  document.TAP_DISPLAY.T_AVG.value = "";
  document.TAP_DISPLAY.T_TAP.value = "";
  document.TAP_DISPLAY.T_RESET.blur();
}

function TapForBPM(e)
{
  console.log(e.keyCode);
  if (e.keyCode == 122) {
    ResetCount();
    return true;
  }
  else {
    addBeat();
  }
}

fin = function () {
    this.flag = r.popup(this.bar.x, this.bar.y, this.bar.value || "0").insertBefore(this);
}
fout = function () {
    this.flag.animate({opacity: 0}, 300, function () {this.remove();});
}

// avg(list, 0.4, 0.6) takes a mean of the middle 20%.
function avg(listIn, start, end) {
  var listCopy = listIn.slice(0);
  listCopy.sort(function(a, b){return a - b});
  var total = 0;
  var l2 = listCopy.slice(Math.floor(start*listCopy.length), Math.floor(end*listCopy.length));
  for (var i = 0; i < l2.length; i++) {
    total += l2[i];
  }
  return total / l2.length;
}

function addBeat() {
  document.TAP_DISPLAY.T_WAIT.blur();
  timeSeconds = new Date;
  msecs = timeSeconds.getTime();
  var bpmAvg;
  
  if (lastTime === null) {
    lastTime = msecs;
  }
  else {
    lengths.push(60000/(msecs - lastTime));
    //lengths = lengths.sort(function(a, b){return a - b});
    lastTime = msecs;
  }

  if ((msecs - msecsPrevious) > 1000 * document.TAP_DISPLAY.T_WAIT.value)
  {
    ResetCount();
  }

  if (count == 0)
  {
    document.TAP_DISPLAY.T_AVG.value = "First Beat";
    document.TAP_DISPLAY.T_TAP.value = "First Beat";
    msecsFirst = msecs;
    count = 1;
  }
  else
  {
    //bpmAvg = 60000 * count / (msecs - msecsFirst);
    bpmAvg = avg(lengths, 0.35, 0.65);
    document.TAP_DISPLAY.T_AVG.value = (Math.round(bpmAvg * 100)) / 100;
    count++;
    document.TAP_DISPLAY.T_TAP.value = count;
  }

  msecsPrevious = msecs;

  r.clear();
  var m1 = lengths.map(Math.round);
  var m2 = m1.map(function(a){return a;});
  //m2.reverse();
  r.barchart(0, 0, 640, 120, [m1]).hover(fin, fout);
  
  return true;

}


function touchStart() {
  document.getElementById("T_TAP").setAttribute("class", "disp tapped");
  addBeat();
}

function touchEnd() {
  document.getElementById("T_TAP").setAttribute("class", "disp");
}

document.onkeypress = TapForBPM;

function ini() {
  document.getElementById("tap_area").addEventListener( 'touchstart', touchStart, false );

  r = Raphael("chart", 640, 120);

  //document.getElementById("tap_area").addEventListener( 'touchend', touchEnd, false );
  //document.getElementById("tap_area").addEventListener( 'mousedown', touchStart, false );
  //document.getElementById("tap_area").addEventListener( 'mouseup', touchEnd, false );
}

</script>

<style type="text/css">
	body {
		font-family: Helvetica;
		background: #ABC;
		color: rgba(0,0,0,0.5);
	}
	.label {
		font-family: monospace;
		text-align: center;
		font-size: 2em;
	}
  .disp {
    font-size: 4em;
    text-align: center;
    background: rgba(0, 0, 0, 0.1);
    color: #000;
    border: none;
    font-family: monospace; 
    width: 100%;
    border-radius: 0.25em;
    max-width: 7em;
  }
  .tapped {
    background: rgba(255, 255, 255,0.8);
  }
	.main {
		border: 1px solid #888;
		border-radius: 1em;
		padding: 0em;
		background: rgba(0, 0, 0, 0.05);
		padding: 1em;
	}
	.notes {
		text-align: center;
	}
	.comment {
		font-size: 70%;
	}
  #chart {
    background: #FFF;
    border-radius: 1em;
  }
</style>
</head>

<body onload="ini()">

<form name="TAP_DISPLAY">
<div class="main">

<div id="tap_area">
<div class="label">Average BPM</div>
<center><input readonly name="T_AVG" id="T_AVG" class="disp" size=12></center>
<div class="label">Timing Taps</div>
<center><input readonly name="T_TAP" id="T_TAP" class="disp" size=12></center>
</div>

<div class="notes">
<p>Use any key - Start tapping to measure BPM<br>
Pres &quot;z&quot; or pause
<select name="T_WAIT">
  <option value="1">1</option>
  <option value="2" SELECTED>2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
</select>
second(s) or <input type="button" name="T_RESET" value="RESET" onclick="ResetCount()"> to start again<br>
Touchscreen? Click here &gt;<input name="T_FOCUS" size=2 maxLength=1>&lt; to activate keyboard.</p>

<div class="comment">
<p>(Tap once per measure for Measures Per Minute - set Pause to 5 seconds)<br>
Based on a <a href="http://www.all8.com/tools/bpm.htm">page</a> by <a href="http://www.all8.com/rich.htm">Rich Reel</a> - <a href="audio.htm">Audio</a> - <a href="./auto/">Auto</a> - <a href="inc/offline/offline.html">Offline</a></p>
</div></div>

<center>
<div id="chart">
</div>
</center>

</div></form>

</body>
</html>